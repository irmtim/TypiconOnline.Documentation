Уставщик
========


Описание
--------

Роль пользователя в системе Типикон.онлайн
Позволяет выполнять следующие задачи:

* Подача заявки на создание нового Устава 
* Редактирование свойств Устава
* Добавление/удаление Редакторов Устава
* Публикация Устава


Подача заявки на создание нового Устава
---------------------------------------

Права доступа
~~~~~~~~~~~~~
Открыто для Уставщика и Администратора

Условия
~~~~~~~
Открыто для зарегистрированного пользователя

Алгоритм
~~~~~~~~~~~~~

1. Пользователь выбирает раздел меню "Уставщик - Уставы".
2. В открывшемся окне Пользователь выбирает действие "Создать новый Устав"
3. В открывшемся окне заполняются поля:
	a. Наименование (обязательно)
		Отображающееся Имя Устава (многоязычное)
	b. Системное имя (обязательно)
		Уникальное в рамках системы имя для Устава, по которому будет усществляться доступ к расписанию для внешних систем
	c. Описание (обязательно)
		Описание Устава (многоязычное), более подробно описывающее Устав
	d. Шаблон (обязательно)
		Устав, который будет взят для основы при создании черновика создаваемого Устава
	e. Язык по умолчанию (обязательно)
		Язык по умолчанию при отображении расписания
4. Пользователь выбирает действие "Создать Устав".
5. Создается Заявка на создание Устава со статусом "Ожидает утверждения".
6. Система возвращает сообщение об успешном завершении процесса.
7. В случае каких-либо ошибок, система возвращает сообщение об ошибке.

Для получения доступа к редактированию свойств Устава заявка должна быть утверждена Администратором системы.

Удаление Заявки на создание Устава
----------------------------------

Права доступа
~~~~~~~~~~~~~
Открыто для Уставщика (владельца Заявки) и Администратора

Условия
~~~~~~~
Доступно для Заявки со статусами:
	• Ожидает утверждения
	• Отклонена

Алгоритм
~~~~~~~~
	1. Пользователь выбирает раздел меню "Уставщик - Уставы".
	2. В открывшемся окне Пользователь выбирает действие "Удалить" для одного из элементов в списке Уставов, являющимся Заявкой.
	3. Для удаления требуется подтверждение действия.
	4. Заявка удаляется.
	5. Система возвращает сообщение об успешном завершении процесса.
	6. В случае каких-либо ошибок, система возвращает сообщение об ошибке.



Редактирование свойств Устава
-----------------------------

Условия
~~~~~~~
Заявка на создание нового Устава должна быть утверждена Администратором системы.

Права доступа
~~~~~~~~~~~~~
Открыто для Уставщика (владельца Устава и включенных в Редакторы Устава) и Администратора.

Описание
~~~~~~~~
Для редактирования открыты свойства:
	* Наименование
	* Язык по умолчанию
	* Является ли Шаблоном

Алгоритм
~~~~~~~~
	1. Изменения сохраняются в БД.
	
	
Редактирование переменных Устава
--------------------------------

Права доступа
~~~~~~~~~~~~~
Открыто для Уставщика (владельца Устава и включенных в Редакторы Устава) и Администратора.

Описание
~~~~~~~~
В случае, если Версия Устава не является Шаблоном, то коллекция Переменных Устава открыта для того, чтобы задать им значения. В заголовке закладки должно отображаться количество переменных Устава (при их наличии публикация Устава невозможна).
Если Версия Устава является Шаблоном, то в дополнение к возможности задать значение Перемнной Устава,
Добавляется возможность редактирования описания Переменных Устава.

Например:
Переменная с именем [eveningservice_nosign] будет иметь описание "Время проведения вечернего богослужения для службы без знака".

Алгоритмы
~~~~~~~~~

Редактирование описания
"""""""""""""""""""""""
	1. Изменения сохраняются в БД.

Присваивание значения переменной
""""""""""""""""""""""""""""""""
	1. Происходит валидация вводимого значения в соответствии с типом Переменной.
	2. Во всех Правилах из коллекции Ссылок на Правила происходит замена обозначения переменной на ее введенное значение.
	3. Переменная удаляется.
	4. Изменения сохраняются в БД.
	

	
Редактирование вложенных коллекций Устава
-----------------------------------------

Права доступа
~~~~~~~~~~~~~
Открыто для Уставщика (владельца Устава и включенных в Редакторы Устава) и Администратора.

Описание
~~~~~~~~
Редактируется версия черновика Устава, изменения вступают в силу только после публикации Устава.

Для редактирования открыты свойства:
	* Коллекция Знаков служб
	* Коллекция Общих правил
	* Коллекция Правил Минеи
	* Коллекция Правил Триоди
	* Коллекция Кафизм

Алгоритм
~~~~~~~~
	1. Изменение/добавление/удаление сохраняются в БД.
	2. В случае изменения Определения Знака службы/Правил производится работа с Переменными Устава:
		a. В новом Определении находятся все указанные имена Переменных Устава
		b. Полученная коллекция сравнивается и синхронизируется с Коллекцией Переменных Устава, связанных с этим Знаком службы/Правилом.
	3. При изменении/добавлении/удалении свойств Устава открывается возможность публикации Устава.
	4. Вносится запись об изменении Правила в Журнал изменений Версии Устава (не реализовано).
	5. Производится проверка коллекции Переменных Устава. Все Переменные, на которые не ссылается ни одно Правило, удаляются.


Публикация Устава
-----------------

Права доступа
~~~~~~~~~~~~~
Открыто для Уставщика (владельца Устава и включенных в Редакторы Устава) и Администратора.

Условия
~~~~~~~
Должны быть соблюдены все условия:
	1. Черновик должен находиться в измененном состоянии (хотя бы единожды должна быть произведена операция редактирования свойств, переменных или вложенных коллекций Устава).
	2. Если версия Устава указана как НЕ ШАБЛОН, то должны отсутствовать Переменные Устава.


Алгоритм
~~~~~~~~
	1. Идет обращение к функции Службы Typicon/Publish с указанием данных Пользователя для авторизации.
	2. Служба возвращает сообщение об успешной инициации процесса.
	
В случае каких-либо ошибок, Служба возвращает сообщение об ошибке.