Уставщик
========


Описание
--------

Роль пользователя в системе Типикон.онлайн
Позволяет выполнять следующие задачи:

* Подача заявки на создание нового Устава 
* Редактирование свойств Устава
* Добавление/удаление Редакторов Устава
* Публикация Устава


Подача заявки на создание нового Устава
---------------------------------------

Права доступа
~~~~~~~~~~~~~
Открыто для Уставщика и Администратора

Условия
~~~~~~~
Открыто для зарегистрированного пользователя

Алгоритм
~~~~~~~~~~~~~

1. Пользователь выбирает раздел меню "Уставщик - Уставы".
2. В открывшемся окне Пользователь выбирает действие "Создать новый Устав"
3. В открывшемся окне заполняются поля:
	a. Наименование (обязательно)
		Отображающееся Имя Устава (многоязычное)
	b. Системное имя (обязательно)
		Уникальное в рамках системы имя для Устава, по которому будет осуществляться доступ к расписанию для внешних систем		
		
		.. attention:: Поле **Системное имя** заполняется единожды. После утверждения Заявки редактирование недоступно. 
	
	c. Описание (обязательно)
		Описание Устава (многоязычное), более подробно описывающее Устав
	d. Шаблон (обязательно)
		Устав, который будет взят для основы при создании черновика создаваемого Устава
	e. Язык по умолчанию (обязательно)
		Язык по умолчанию при отображении расписания
4. Пользователь выбирает действие "Создать Устав".
5. Создается Заявка на создание Устава со статусом "Ожидает утверждения".
6. Система возвращает сообщение об успешном завершении процесса.
7. В случае каких-либо ошибок, система возвращает сообщение об ошибке.

Для получения доступа к редактированию свойств Устава заявка должна быть утверждена Администратором системы.



Удаление Заявки на создание Устава
----------------------------------

Права доступа
~~~~~~~~~~~~~
Открыто для Уставщика (владельца Заявки) и Администратора

Условия
~~~~~~~
Доступно для Заявки со статусами:
	• Ожидает утверждения
	• Отклонена

Алгоритм
~~~~~~~~
	1. Пользователь выбирает раздел меню "Уставщик - Уставы".
	2. В открывшемся окне Пользователь выбирает действие "Удалить" для одного из элементов в списке Уставов, являющимся Заявкой.
	3. Для удаления требуется подтверждение действия.
	4. Заявка удаляется.
	5. Система возвращает сообщение об успешном завершении процесса.
	6. В случае каких-либо ошибок, система возвращает сообщение об ошибке.



Редактирование свойств Устава
-----------------------------

Условия
~~~~~~~
Заявка на создание нового Устава должна быть утверждена Администратором системы.

Права доступа
~~~~~~~~~~~~~
Открыто для Уставщика (владельца Устава и включенных в Редакторы Устава) и Администратора.

Описание
~~~~~~~~
Для редактирования открыты свойства:
	* Наименование
	* Язык по умолчанию
	* Является ли Шаблоном

Алгоритм
~~~~~~~~
	1. Изменения сохраняются в БД.
	

Настройка графика богослужений
-----------------------------

Условия
~~~~~~~
Заявка на создание нового Устава должна быть утверждена Администратором системы.

Права доступа
~~~~~~~~~~~~~
Открыто для Уставщика (владельца Устава и включенных в Редакторы Устава) и Администратора.

Описание
~~~~~~~~
Позволяет настроить условия, по каким дням совершаются богослужения. 

Можно настраивать по следующим критериям:

	1. **Дни недели** (с понедельника по воскресенье).
		.. important:: Если отмечены все дни недели, то служба совершается **ежедневно**.
	
	2. **Знаки службы**
		Указываются Знаки служб, с которыми совершаются богослужения.
	
	3. **Дни Минеи**
		Указываются праздники календарного года, для которых совершаются богослужения.
	
	4. **Дни Триоди**
		Указываются праздники Триоди, для которых совершаются богослужения.
	
При формировании расписания на определенную дату система проверяет, входит ли вычисляемый день хотя бы в один из указанных разделов.

Пример
""""""

В графике богослужений Устава определено:
	* Дни недели
	Суббота, воскресенье
	
	* Знаки служб
	Бдение, двунадесятые праздники
	
	* Минея
	Мч. Вонифатия (1 января). Прав. Иоанна Кронштадского ( 2 января).
	
	* Триодь
	Пасха
	
Допустим, система создает расписание на 10 октября 2020 года. Это суббота, поэтому расписание будет сформировано.
Если бы это было не суббота или воскресенье, следовала бы проверка, какой знак службы у этого дня. Если бдение или двунадесятый праздник - расписание будет сформировано.
В противном случае проверялось бы, входит ли данный день (10 февраля) в один из указанных дней Минеи.
Если нет, то проверялось бы, приходится ли данный день на один из дней Триоди, указанных в списке.
Если на все проверки был получен отрицательный ответ, расписание на этот день не формируется.

Для каждого элемента вышеуказанных разделов имеется возможность определить последовательность богослужений.


Валидность данных Устава
~~~~~~~~~~~~~~~~~~~~~~~~

Устав становится правильно заполненным, когда для любого дня года может быть определена последовательность.
Это осуществляется, если:

	1. Для каждого выбранного дня недели определена последовательность.
	Этого условия достаточно, чтобы опубликовать Устав.
	
	Например:
		a. Служба совершается только по воскресеньям и субботам. В этом случае для субботы и воскресенья должны быть определены последовательности.
		b. Служба совершается каждый день. Для каждого дня недели (с понедельника по воскресенье) должны быть определены последовательности.
	
	2. Не для всех дней недели определена последовательность.
	В таком случае для всех корневых Знаков службы должна быть определена последовательность. Таким образом будет сохранена целостность данных.
	
**Корневые знаки службы** - это Знаки службы, у которых нет родительского Знака службы.

.. figure:: _static/rootsign.png
       :scale: 100 %
       :align: center
       :alt: Корневой знак службы

       Корневой знак службы

На корневые знаки службы в конечном счете ссылаются все существующие правила Минеи и Триоди, и если для них (корневых знаков службы) будет определена последовательность богослужений, значит для каждого правила Минеи и Триоди будет определена последовательность.

	
	
Редактирование переменных Устава
--------------------------------

Права доступа
~~~~~~~~~~~~~
Открыто для Уставщика (владельца Устава и включенных в Редакторы Устава) и Администратора.

Описание
~~~~~~~~
В случае, если Версия Устава не является Шаблоном, то коллекция Переменных Устава открыта для того, чтобы задать им значения. В заголовке закладки должно отображаться количество переменных Устава (при их наличии публикация Устава невозможна).
Если Версия Устава является Шаблоном, то в дополнение к возможности задать значение Перемнной Устава,
Добавляется возможность редактирования описания Переменных Устава.

Например:
Переменная с именем [eveningservice_nosign] будет иметь описание "Время проведения вечернего богослужения для службы без знака".

Алгоритмы
~~~~~~~~~

Редактирование описания
"""""""""""""""""""""""
	1. Изменения сохраняются в БД.

Присваивание значения переменной
""""""""""""""""""""""""""""""""
	1. Происходит валидация вводимого значения в соответствии с типом Переменной.
	2. Во всех Правилах из коллекции Ссылок на Правила происходит замена обозначения переменной на ее введенное значение.
	3. Переменная удаляется.
	4. Изменения сохраняются в БД.
	

	
Редактирование вложенных коллекций Устава
-----------------------------------------

Права доступа
~~~~~~~~~~~~~
Открыто для Уставщика (владельца Устава и включенных в Редакторы Устава) и Администратора.

Описание
~~~~~~~~
Редактируется версия черновика Устава, изменения вступают в силу только после публикации Устава.

Для редактирования открыты свойства:
	* Коллекция Знаков служб
	* Коллекция Общих правил
	* Коллекция Правил Минеи
	* Коллекция Правил Триоди
	* Коллекция Кафизм

Алгоритм
~~~~~~~~
	1. Изменение/добавление/удаление сохраняются в БД.
	2. В случае изменения Определения Знака службы/Правил производится работа с Переменными Устава:
		a. В новом Определении находятся все указанные имена Переменных Устава
		b. Полученная коллекция сравнивается и синхронизируется с Коллекцией Переменных Устава, связанных с этим Знаком службы/Правилом.
	3. При изменении/добавлении/удалении свойств Устава открывается возможность публикации Устава.
	4. Вносится запись об изменении Правила в Журнал изменений Версии Устава (не реализовано).
	5. Производится проверка коллекции Переменных Устава. Все Переменные, на которые не ссылается ни одно Правило, удаляются.

	
Изменение списка редакторов Устава
----------------------------------

Права доступа
~~~~~~~~~~~~~
Открыто для Уставщика (владельца Устава) и Администратора.

Алгоритм
~~~~~~~~~~~~~
	1.	На странице редактирования Устава Пользователь выбирает закладку «Редакторы». В случае, если Пользователь не является создателем Устава или не «Администратор», закладка недоступна.
	2.	Отображается таблица с именами Пользователей, которые являются Редакторами данного Устава. Напротив каждого имеется кнопка «Исключить», по нажатию на которую Пользователь исключается из Редакторов Устава.
	3.	Внизу таблицы находится поле для ввода. При внесении данных в поле производится поиск Пользователей, с указанным именем или электронной почтой.
	4.	При выборе Пользователя становится доступной кнопка «Добавить», по нажатию на которую Пользователь добавляется в Редакторы Устава.

	

Публикация Устава
-----------------

Права доступа
~~~~~~~~~~~~~
Открыто для Уставщика (владельца Устава и включенных в Редакторы Устава) и Администратора.

Условия
~~~~~~~
Должны быть соблюдены все условия:
	1. Черновик должен находиться в измененном состоянии (хотя бы единожды должна быть произведена операция редактирования свойств, переменных или вложенных коллекций Устава).
	2. Если версия Устава указана как **НЕ ШАБЛОН**, то должны быть выполнены условия:
		* отсутствовать Переменные Устава.
		* Должны быть определены настройки Дней богослужений.


Алгоритм
~~~~~~~~
	1. Идет обращение к функции Службы Typicon/Publish с указанием данных Пользователя для авторизации.
	2. Служба возвращает сообщение об успешной инициации процесса.
	
В случае каких-либо ошибок, Служба возвращает сообщение об ошибке.